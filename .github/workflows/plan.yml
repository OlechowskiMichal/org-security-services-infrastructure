name: 'OpenTofu Plan'

on:
  push:
    branches: [main, master]
    paths:
      - 'tofu/**'
      - 'conftest.toml'
      - '.github/workflows/plan.yml'
  pull_request:
    paths:
      - 'tofu/**'
      - 'conftest.toml'
      - '.github/workflows/plan.yml'
  workflow_call:
    secrets:
      AWS_ROLE_PLAN:
        required: true

permissions:
  contents: read
  id-token: write  # Required for AWS OIDC authentication
  pull-requests: write

concurrency:
  group: tofu-plan-${{ github.ref }}
  cancel-in-progress: true

jobs:
  plan:
    name: Plan Infrastructure Changes
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 30

    steps:
      - name: Setup
        uses: OlechowskiMichal/ci-shared/actions/setup/mise@v1
        with:
          mise-env: ci

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_PLAN }}
          aws-region: us-east-1

      - name: Tofu Format Check
        id: fmt
        timeout-minutes: 2
        uses: OlechowskiMichal/ci-shared/actions/tofu/fmt-check@v1

      - name: Tofu Init
        id: init
        timeout-minutes: 5
        uses: OlechowskiMichal/ci-shared/actions/tofu/init@v1

      - name: Tofu Validate
        id: validate
        timeout-minutes: 2
        uses: OlechowskiMichal/ci-shared/actions/tofu/validate@v1

      - name: Tofu Plan
        id: plan
        timeout-minutes: 10
        uses: OlechowskiMichal/ci-shared/actions/tofu/plan@v1

      - name: Upload Plan JSON
        uses: actions/upload-artifact@v4
        timeout-minutes: 3
        with:
          name: tofu-plan
          path: tofu/plan.json
          retention-days: 90

      - name: Run Conftest Policy Tests
        id: policy
        timeout-minutes: 5
        uses: OlechowskiMichal/ci-shared/actions/tofu/policy@v1
        with:
          plan-json: ${{ steps.plan.outputs.plan-json }}

      - name: Build Step Summary
        if: github.event_name == 'pull_request'
        id: step-summary
        timeout-minutes: 2
        uses: OlechowskiMichal/ci-shared/actions/tofu/build-step-summary@v1
        with:
          fmt_outcome: ${{ steps.fmt.outcome }}
          init_outcome: ${{ steps.init.outcome }}
          validate_outcome: ${{ steps.validate.outcome }}
          plan_outcome: ${{ steps.plan.outcome }}

      - name: Build Plan Details
        if: github.event_name == 'pull_request'
        id: plan-details
        timeout-minutes: 2
        uses: OlechowskiMichal/ci-shared/actions/tofu/build-plan-details@v1
        with:
          plan: ${{ steps.plan.outputs.plan }}

      - name: Build Policy Summary
        if: github.event_name == 'pull_request'
        id: policy-summary
        timeout-minutes: 2
        uses: OlechowskiMichal/ci-shared/actions/tofu/build-policy-summary@v1
        with:
          has_violations: ${{ steps.policy.outputs.has_violations }}
          actor: ${{ github.actor }}

      - name: Post Plan to PR
        if: github.event_name == 'pull_request'
        timeout-minutes: 2
        uses: OlechowskiMichal/ci-shared/actions/github/comment@v1
        with:
          comment-body: |
            ${{ steps.step-summary.outputs.step-summary }}
            ${{ steps.plan-details.outputs.plan-details }}
            ${{ steps.policy-summary.outputs.policy-summary }}
          comment-identifier: '### OpenTofu Plan Results'

      - name: Fail on Policy Violations
        if: steps.policy.outputs.has_violations == 'true'
        timeout-minutes: 1
        env:
          POLICY_VIOLATIONS: ${{ steps.policy.outputs.policy_violations }}
        run: mise exec -- task ci:policy:fail

      - name: Plan Summary
        timeout-minutes: 1
        env:
          FMT_OUTCOME: ${{ steps.fmt.outcome }}
          INIT_OUTCOME: ${{ steps.init.outcome }}
          VALIDATE_OUTCOME: ${{ steps.validate.outcome }}
          PLAN_OUTCOME: ${{ steps.plan.outcome }}
          POLICY_STATUS: ${{ steps.policy.outputs.has_violations == 'true' && 'FAILED' || 'PASSED' }}
        run: mise exec -- task ci:plan:summary
